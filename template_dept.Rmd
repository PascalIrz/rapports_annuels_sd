---
title: "Bilan des pêches dans le `r params$mon_dept`"
author: "OFB - DR Bretagne"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output:
  bookdown::word_document2
always_allow_html: true
params:
  mon_dept: "22"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```




```{r}
library(aspe)
library(tidyverse)
library(flextable)

rdata_tables <- misc_nom_dernier_fichier(repertoire = "../../../projets/ASPE/raw_data/processed_data",
                                         pattern = "^tables")

load(rdata_tables)

rdata_mei <- misc_nom_dernier_fichier(repertoire = "../../../projets/ASPE/raw_data/processed_data",
                                      pattern = "^mei")

load(rdata_mei)
```

```{r}
source(file = "fonctions.R")
```


```{r}
# création de la passerelle et ajout des codes dept et région
reg_data <- mef_creer_passerelle() %>% 
  mef_ajouter_dept() %>% 
  left_join(COGiter::departements %>% select(DEP, REG),
            by = c("dept" = "DEP")) %>% 
  left_join(COGiter::regions %>% select(REG,
                                        region = NOM_REG))


ma_reg <- reg_data %>% 
  filter(dept == params$mon_dept) %>% 
  slice(1) %>% 
  pull(region) %>% 
  as.character()

reg_data <- reg_data %>% 
  select(-REG) %>% 
  filter(region == ma_reg) %>% 
  mef_ajouter_objectif() %>% 
  mef_ajouter_ope_date() %>% 
  filter(obj_libelle %in% c("RCS – Réseau de Contrôle de Surveillance",
                             "RHP – Réseau Hydrobiologique Piscicole",
                             "RRP – Réseau de Référence Pérenne"),
         annee > 1997)

# sélection des opérations, ajout date et libelle de la station
reg_ope <- reg_data %>% 
  select(sta_id,
         pop_id,
         ope_id,
         dept,
         region,
         annee) %>% 
  distinct() %>% 
  mef_ajouter_libelle()

mes_operations <- reg_ope %>% 
  pull(ope_id)

# nb de pêches par point
# annees_par_point <- reg_ope %>% 
#   group_by(pop_id) %>% 
#   summarise(n_annees = n_distinct(annee))

# filtrage des opérations sur les dates et mini 6 pêches
# reg_ope <- reg_ope %>% 
#   left_join(annees_par_point) %>% 
#   filter(n_annees > 6,
#          annee > 1999)
```


```{r}
# ma_region <- reg_data %>% 
#   filter(dept == params$mon_dept) %>% 
#   slice(1) %>% 
#   pull(region)
```


# IPR


```{r}
reg_ipr <- reg_ope %>% 
  mef_ajouter_ipr() %>% 
  filter(!is.na(ipr))

dept_ipr <- reg_ipr %>%
  filter(dept == params$mon_dept)
```

## Graphiques par station depuis 2000

```{r, fig.width = 10, fig.height = reg_ipr %>% filter(dept == params$mon_dept) %>% pull(pop_libelle) %>% unique %>% length %>% `/`(2)}
classe_ipr <- classe_ipr %>%
  aspe::ip_completer_classes_couleur()

dept_ipr %>%
  gg_temp_ipr(var_id_sta = pop_libelle,
              var_ipr = ipr,
              nb_colonnes = 5)
```

## Tableau depuis 2010


```{r, fig.width = 10}
table_ipr <- dept_ipr %>% 
  filter(annee > 2009) %>%
  mutate(ipr = round(ipr, 1)) %>% 
  select(pop_libelle, annee, ipr) %>% 
  spread(key = annee,
         value = ipr) %>%  # pb dans l'ordre des colonnes avec pivot_wider()
  replace(is.na(.), "-")

flextable(table_ipr) %>% 
  fontsize(size = 8, part = "all") %>% 
  set_table_properties(layout = "autofit", width = 1)
```

## Echelle départementale


```{r}
reg_ipr_mediane <- reg_ipr %>%
  group_by(annee) %>%
  summarise(ipr_med = median(ipr)) %>%
  ungroup()
```

Valeur médiane de l'IPR du département (pointillés) et quantiles 25% et 75% (zone grisée). La tendance linéaire est indiquée en bleu.

```{r}
dept_ipr %>%
  group_by(annee) %>%
  summarise(
    ipr25 = quantile(ipr, 0.25),
    ipr50 = quantile(ipr, 0.50),
    ipr75 = quantile(ipr, 0.75)
  ) %>%
  mutate(pop_libelle = params$mon_dept) %>%
  aspe::gg_temp_ipr(var_id_sta = pop_libelle,
                    var_ipr = ipr50,
                    nb_colonnes = 5) +
  geom_ribbon(aes(
    x = annee,
    y = ipr50,
    ymin = ipr25,
    ymax = ipr75
  ),
  alpha = 0.2) +
  geom_smooth(aes(x = annee,
                  y = ipr50),
              method = "lm",
              se = FALSE,
              size = 0.5) +
  ylab("IPR médian") +
  theme(legend.position = "bottom",
        strip.text.x = element_text(size = 10),
        axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  geom_line(data = reg_ipr_mediane,
            aes(x = annee,
                y = ipr_med),
            col = "brown")
```

Interprétation du graphique ci-dessus : En pointillés c’est la médiane annuelle de l’IPR. La zone grisée les quantiles 25% et 75% (homologues de la « boite » dans les boîtes à moustache). En bleu c’est la tendance linéaire pour le département et en marron la médiane régionale.


# Les espèces

## Caractérisation de la dynamique

On opère une suite d'opérations :

- filtrage des données nationales sur les opérations de la région depuis 1999 
- ajout aux données à l'opération de la date et des lots
- suppression des hybrides et les codes "CYP" (cyprinidés non déterminés à l'espèce)
- recodages des carpes, vandoises etc.
- agrégation des captures à l'opération
- ajout des surfaces prospectées



```{r}
dept_sp <- reg_data %>%  
  # filter(#ope_id %in% unique(reg_ope$ope_id),
  #        dept == params$mon_dept) %>% 
  mef_ajouter_lots() %>%  # ajout des lots
 # mef_ajouter_ope_date() %>% # ajout date
  filter(!esp_code_alternatif %in% c("HBG", "CYP")) %>% 
  mutate(esp_code_alternatif = case_when(   # recodages à l'espèce
    esp_code_alternatif %in% c("CCU", "CCX", "CMI") ~ "CCO",
    esp_code_alternatif %in% c("CAG", "CAD", "CAA", "CAS", "CAX") ~ "CAR",
    esp_code_alternatif == "VAN" ~ "VAR",
    esp_code_alternatif == "BRX" ~ "BRE",
    esp_code_alternatif == "GOX" ~ "GOU",
    TRUE ~ esp_code_alternatif
    )) %>%
  group_by(sta_id,
           pop_id,
           ope_date,
           ope_id,
           annee,
           dept,
           esp_code_alternatif) %>% 
  summarise(effectif = sum(lop_effectif)) %>% 
  ungroup() %>% 
  mef_ajouter_surf_calc() %>% # ajout de la surface prospectée 
  mutate(effectif = replace_na(effectif, 0)) %>% 
  droplevels()
```

On complète le tableau avec les absences et calcul des densités (nombre d'individus pour 1000 m²). Pour certains graphiques on veut représenter les dynamiques départementales en regard des dynamiques régionales donc on calcule les densités à ces deux échelles et on les rassemble dans un même data frame.

```{r}
# densités à l'opération au niveau départemental
dept_sp <- dept_sp %>% 
  pivot_wider(names_from = esp_code_alternatif,
              values_from = effectif,
              values_fill = 0) %>% 
  pivot_longer(cols = -(sta_id:ope_surface_calculee),
               names_to = "esp_code_alternatif",
               values_to = "effectif") %>% 
  mutate(densite = 1000 * effectif / ope_surface_calculee)

# agrégation annuelle par département et par espèce
dept_densites_an <- dept_sp %>% 
  group_by(dept, annee, esp_code_alternatif) %>% 
    summarise(densite_qd_pres_med = median(densite, na.rm = TRUE),
              densite_qd_pres_moy = mean(densite, na.rm = TRUE),
              densite_yc_abs_moy = 1000 * sum(effectif, na.rm = TRUE) / sum(ope_surface_calculee, na.rm = TRUE))

# idem mais à l'échelle régionale
# reg_densites_an <- reg_sp %>% 
#   group_by(annee, esp_code_alternatif) %>% 
#     summarise(densite_reg_qd_pres_med = median(densite, na.rm = TRUE),
#               densite_reg_qd_pres_moy = mean(densite, na.rm = TRUE),
#               densite_reg_yc_abs_moy = 1000 * sum(effectif, na.rm = TRUE) / sum(ope_surface_calculee, na.rm = TRUE))

# regroupement des deux
# dept_densites_an <- dept_densites_an %>% 
#   left_join(reg_densites_an) %>% 
#   ungroup()

# noms d'espèces en clair
dept_densites_an <- dept_densites_an %>% 
  left_join(y = ref_espece %>% 
              select(esp_code_alternatif,
                     esp_nom_commun))
```

## Espèces

On a des graphiques séparés pour les écrevisses, les poissons EEE et les autres espèces. Les espèces sont ordonnées par densités moyennes décroissantes. Les échelles des axes des densités sont différents selon les espèces pour éviter que les plus abondantes n'écrasent les autres qui deviendraient illisibles.

On a en ordonnée la densité moyenne du taxon chaque dans le département.



```{r}
# Liste des noms d'espèces par groupe
ecr <- ref_espece %>% 
  filter(str_detect(esp_nom_commun, "Ecrevisse") | esp_code_alternatif == "APT") %>% 
  filter(esp_code_alternatif != "ECR") %>% 
  pull(esp_nom_commun)

eee <- ref_espece %>% 
  filter(esp_code_alternatif %in% c("PES", "PCH", "PSR", "OPG")) %>% 
  pull(esp_nom_commun)

poissons_loc <- dept_densites_an %>% 
  pull(esp_nom_commun) %>% 
  unique() %>% 
  setdiff(eee) %>% 
  setdiff(ecr)
```



```{r}
# Nombre de taxon par groupe
n_poissons_loc <- length(poissons_loc)
n_eee <- dept_densites_an %>% 
  filter(esp_nom_commun %in% eee) %>% 
  pull(esp_nom_commun) %>% 
  unique() %>% 
  length()
n_ecr <- dept_densites_an %>% 
  filter(esp_nom_commun %in% ecr) %>% 
  pull(esp_nom_commun) %>% 
  unique() %>% 
  length()
```

### Poissons

Calcul des dimensions des figures à afficher en fonction du nombre d'espèces dans chaque groupe.

```{r}
fig_haut_poissons <- n_poissons_loc %>%
  `/`(6) %>% 
  ceiling() %>% 
  `*`(1.5) %>% 
  `+` (0.5)

fig_haut_ecr <- n_ecr %>%
  `/`(4) %>% 
  ceiling() %>% 
  `*`(1.5) %>% 
  `+` (0.5)

fig_haut_eee <- n_eee %>%
  `/`(4) %>% 
  ceiling() %>% 
  `*`(1.5) %>% 
  `+` (0.5)

fig_larg_eee <- n_eee * 2.35
```


```{r}
densites <- dept_densites_an %>%
  filter(esp_nom_commun %in% poissons_loc)
```

Graphique. 

```{r, fig.width = 10, fig.height = fig_haut_poissons}
densites %>% 
  filter(dept == params$mon_dept) %>% 
  aspe::gg_temp_abondance(var_abondance = densite_yc_abs_moy,
                          var_espece = esp_nom_commun,
                          nb_colonnes = 4)
```

```{r, fig.width = 10, fig.height = fig_haut_poissons}
densites %>% 
  gg_temp_abondance_groupe(var_abondance = densite_yc_abs_moy,
                           var_espece = esp_nom_commun,
                           var_groupe = dept,
                           groupe = 22,
                           nb_colonnes = 4)
```

Sans transformer en log l'axe des ordonnées :

```{r, fig.width = 10, fig.height = fig_haut_poissons}
densites %>% 
  gg_temp_abondance_groupe(var_abondance = densite_yc_abs_moy,
                           var_espece = esp_nom_commun,
                           var_groupe = dept,
                           groupe = 22,
                           nb_colonnes = 4,
                           log_axe_y = FALSE)
```

### Ecrevisses

```{r, fig.width = 10, fig.height = fig_haut_ecr}
dept_densites_an %>%
  filter(esp_nom_commun %in% ecr,
         dept == params$mon_dept) %>% 
  gg_temp_abondance(var_abondance = densite_yc_abs_moy,
                    var_espece = esp_nom_commun,
                    nb_colonnes = 4)
```

### Poissons EEE

```{r, fig.height = fig_haut_eee, fig.width = fig_larg_eee}
dept_densites_an %>%
  filter(esp_nom_commun %in% eee,
         dept == params$mon_dept) %>% 
  gg_temp_abondance(var_abondance = densite_yc_abs_moy,
                    var_espece = esp_nom_commun,
                    nb_colonnes = 4)
```


# Essais

## Les espèces par département

Ici la taille des points indique le pourcentage des stations échantillonnées dans le département où l'espèce était présente (pour la dernière année de données). Les écrevisses sont indiquées en bleu. Les espèces sont ordonnées par nombre de départements de présence, puis par nombre total d'occurrences.

Exemple : Si, dans le 56, le chevaine a été capturé sur 8 des 16 stations prospectées en 2022. Son taux d'occurrence dans ce département est donc de 50%. 

```{r, fig.height=9, fig.width = 7, dpi=300}
reg_esp <- reg_data %>% 
  mef_ajouter_dept() %>% 
#  mef_ajouter_ope_date() %>% 
  mef_ajouter_lots() %>% 
  # mef_ajouter_objectif() %>% 
  # filter(obj_libelle %in% c("RCS – Réseau de Contrôle de Surveillance",
  #                           "RHP – Réseau Hydrobiologique Piscicole",
  #                           "RRP – Réseau de Référence Pérenne")) %>% 
  filter(annee == 2021) %>% 
  mutate(esp_code_alternatif = ifelse(esp_code_alternatif == "CMI",
                                      "CCO",
                                      esp_code_alternatif)) %>% 
  group_by(pop_id, dept, esp_code_alternatif) %>% 
    summarise(effectif = sum(lop_effectif)) %>% 
  left_join(y = ref_espece %>% 
              select(esp_code_alternatif, esp_nom_commun)) %>% 
  mutate(esp_nom_commun = paste0(esp_nom_commun,
                                 " (",
                                 esp_code_alternatif,
                                 ")"))


nb_pop_par_dept <- reg_esp %>% 
  group_by(dept) %>% 
    summarise(n_pop = n_distinct(pop_id))

n_occ_par_esp_par_dept <- reg_esp %>% 
  group_by(dept, esp_nom_commun) %>% 
    tally()

pc_occ_par_dept <- n_occ_par_esp_par_dept %>% 
  left_join(y = nb_pop_par_dept) %>% 
  mutate(pc_occ = n / n_pop,
         dept_fct = as.factor(dept),
         dept_fct = fct_relevel(dept_fct, "35", "56", "29", "22"))

ordre_esp <- reg_esp %>% 
  group_by(esp_nom_commun) %>% 
  summarise(n_dept = n_distinct(dept),
            n_occ = sum(effectif > 0)) %>% 
  ungroup() %>% 
  arrange(n_dept, n_occ)

pc_occ_par_dept <- pc_occ_par_dept %>% 
  left_join(ordre_esp) %>%
  mutate(esp_nom_commun = factor(esp_nom_commun,
                                 ordre_esp$esp_nom_commun),
         couleur = ifelse(str_detect(esp_nom_commun, "Ecrev"),
                          "blue",
                          "black"))

couleurs <- pc_occ_par_dept %>% 
  group_by(esp_nom_commun) %>% 
  slice(1) %>% 
  pull(couleur)

ggplot(data = pc_occ_par_dept,
       aes(x = dept_fct,
           y = esp_nom_commun,
           size = pc_occ)) +
  geom_point(col = "darkgreen") +
  scale_size_area(labels = scales::percent) +
  scale_x_discrete(position = 'top') +
  labs(x = "Département",
       y = "",
       size = "Taux d'occurrence") +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 8),
        axis.text.y = element_text(colour = couleurs),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 9))
```

## Distribution en taille, pour le département

En inter-annuel, pour les 10 espèces avec les effectifs les plus abondants.

```{r}
mei <- reg_data %>% 
  filter(dept == params$mon_dept) %>% 
  left_join(y = mesure_individuelle %>% 
              select(mei_id,
                     lop_id = mei_lop_id,
                     mei_taille,
                     mei_poids,
                     mei_poids_estime,
                     mei_mesure_reelle,
                     mei_tlo_id))

mei <- mei %>% 
  filter(mei_taille > 0) %>% 
  mef_ajouter_lots() %>% 
  mef_ajouter_esp()

# Histo cumulé pluri-annuel : Les espèces avec mini 1000 individus sur la période
mes_especes <- mei %>% 
  group_by(esp_code_alternatif) %>% 
  tally() %>% 
  # arrange(-n) %>% 
  # slice(1:10) %>% 
  pull(esp_code_alternatif)

mei <- mei %>% 
  filter(esp_code_alternatif %in% mes_especes)

```

```{r, fig.height = 8, results = 'hide'}
map(.x = mes_especes,
    .f = gg_dyn_esp,
    df = mei,
    var_id_espece = esp_code_alternatif,
    var_id_station = pop_id,
    seuil = 0.01,
    graph_long_mediane = FALSE,
    graph_mois = FALSE,
    graph_effectif = F
)
```

## Variables environnementales

```{r}
# données environnementales simples à l'opération
mes_donnees_env <- operation_description_peche %>% 
  filter(odp_ope_id %in% mes_operations) %>% 
  select(ope_id = odp_ope_id,
         odp_conductivite,
         odp_temperature_instantanee,
         odp_tension,
         odp_largeur_lame_eau
         ) %>% 
  left_join(y = operation_donnees_environnementales %>% 
              select(ope_id = ode_ope_id,
                     ode_profondeur_moyenne_station))

# granulométrie dominante par opération
granu <- facies %>% 
  select(ope_id = fac_ode_ope_id,
         fac_tyf_id,
         fac_importance_relative,
         fac_gra_id_dominante) %>% 
  filter(ope_id %in% mes_operations) %>% 
  group_by(ope_id) %>% 
  summarise(granu_dom = weighted.mean(x = fac_gra_id_dominante,
                                      w = fac_importance_relative,
                                      na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(granu_dom = round(granu_dom))


# assemblage des deux tables
mes_donnees_env <- mes_donnees_env %>% 
  left_join(y = granu) %>%  
  pivot_longer(cols = odp_conductivite:granu_dom,
               names_to = "variable",
               values_to = "valeur") %>% 
  mef_ajouter_ope_date() %>% 
  select(-ope_date) %>% 
  group_by(annee, variable) %>% 
    summarise(mediane = median(valeur, na.rm = TRUE)) %>% 
  ungroup()
```

```{r}
ggplot(data = mes_donnees_env,
       aes(x = annee,
           y = mediane)) +
  geom_line() +
  facet_wrap(~variable,
             scales = "free_y")
```

## Métriques IPR

```{r}
metrique <- operation_ipr %>% 
  filter(opi_ope_id %in% mes_operations) %>% 
  select(ope_id = opi_ope_id,
         opi_ner:opi_dti) %>% 
  mef_ajouter_ope_date() %>% 
  select(-ope_date) %>% 
  pivot_longer(cols = opi_ner:opi_dti,
          names_to = "metrique", values_to = "valeur") %>% 
  
   group_by(annee, metrique) %>% 
    summarise(mediane = median(valeur, na.rm = TRUE)) %>% 
  ungroup()
```

```{r}
ggplot(data = metrique,
       aes(x = annee,
           y = mediane)) +
  geom_line() +
  facet_wrap(~metrique,
             scales = "free_y")
```
