---
title: "Synthèse pêches électriques réseaux `r params$mon_annee`"
subtitle: "Prétraitements échelle régionale"
author: "OFB - DR Bretagne"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output:
  bookdown::word_document2
always_allow_html: true
params:
  mon_dept: "22"
  mon_annee: "2021"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```




```{r}
# devtools::install_github("pascalirz/aspe")
# devtools::install_github("pascalirz/ggplotExtra")
library(aspe)
library(tidyverse)

rdata_tables <- misc_nom_dernier_fichier(repertoire = "../../../../projets/ASPE/raw_data/rdata",
                                         pattern = "^tables")

load(rdata_tables)

rdata_mei <- misc_nom_dernier_fichier(repertoire = "../../../../projets/ASPE/raw_data/rdata",
                                      pattern = "^mei")

load(rdata_mei)
```

```{r}
# création de la passerelle et ajout des codes dept et région
reg_data <- mef_creer_passerelle() %>% 
  mef_ajouter_dept() %>% 
  left_join(COGiter::departements %>% select(DEP, REG),
            by = c("dept" = "DEP")) %>% 
  left_join(COGiter::regions %>% select(REG,
                                        region = NOM_REG))

# Région du département choisi
ma_reg <- reg_data %>% 
  filter(dept == params$mon_dept) %>% 
  slice(1) %>% 
  pull(region) %>% 
  as.character()

# filtrage du jeu de données sur les réseaux, la région et l'année de départ
reg_data <- reg_data %>%
  select(-REG) %>%
  filter(region == ma_reg) %>%
  mef_ajouter_objectif() %>%
  mef_ajouter_ope_date() %>%
  filter(
    obj_libelle %in% c(
      "RCS – Réseau de Contrôle de Surveillance",
      "RHP – Réseau Hydrobiologique Piscicole",
      "RRP – Réseau de Référence Pérenne"
    ),
    annee > 1997
  )

# sélection des opérations, ajout date et libelle de la station
reg_ope <- reg_data %>% 
  select(sta_id,
         pop_id,
         ope_id,
         dept,
         region,
         annee) %>% 
  distinct() %>% 
  mef_ajouter_libelle()

# vecteur des ope_id retenus
mes_ope_reg <- reg_ope %>% 
  pull(ope_id)
```


# IPR


```{r}
reg_ipr <- reg_ope %>% 
  mef_ajouter_ipr() %>% 
  filter(!is.na(ipr))

reg_ipr_mediane <- reg_ipr %>%
  group_by(annee) %>%
  summarise(ipr_med = median(ipr)) %>%
  ungroup()
```


# Les espèces

## Caractérisation de la dynamique

On opère une suite d'opérations :

- filtrage des données nationales sur les opérations de la région depuis 1999 
- ajout aux données à l'opération de la date et des lots
- suppression des hybrides et les codes "CYP" (cyprinidés non déterminés à l'espèce)
- recodages des carpes, vandoises etc.
- agrégation des captures à l'opération
- ajout des surfaces prospectées



```{r}
reg_sp <- reg_data %>%  
  mef_ajouter_lots() %>%  # ajout des lots
  filter(!esp_code_alternatif %in% c("HBG", "CYP")) %>% 
  mutate(esp_code_alternatif = case_when(   # recodages à l'espèce
    esp_code_alternatif %in% c("CCU", "CCX", "CMI") ~ "CCO",
    esp_code_alternatif %in% c("CAG", "CAD", "CAA", "CAS", "CAX") ~ "CAR",
    esp_code_alternatif == "VAN" ~ "VAR",
    esp_code_alternatif == "BRX" ~ "BRE",
    esp_code_alternatif == "GOX" ~ "GOU",
    TRUE ~ esp_code_alternatif
    )) %>%
  group_by(sta_id,
           pop_id,
           ope_date,
           ope_id,
           annee,
           dept,
           esp_code_alternatif) %>% 
  summarise(effectif = sum(lop_effectif)) %>% 
  ungroup() %>% 
  mef_ajouter_surf_calc() %>% # ajout de la surface prospectée 
  mutate(effectif = replace_na(effectif, 0)) %>% 
  droplevels()
```

On complète le tableau avec les absences et calcul des densités (nombre d'individus pour 1000 m²). Pour certains graphiques on veut représenter les dynamiques départementales en regard des dynamiques régionales donc on calcule les densités à ces deux échelles et on les rassemble dans un même data frame.

```{r}
# densités à l'opération au niveau départemental
reg_sp <- reg_sp %>% 
  pivot_wider(names_from = esp_code_alternatif,
              values_from = effectif,
              values_fill = 0) %>% 
  pivot_longer(cols = -(sta_id:ope_surface_calculee),
               names_to = "esp_code_alternatif",
               values_to = "effectif") %>% 
  mutate(densite = 1000 * effectif / ope_surface_calculee)

# agrégation annuelle par département et par espèce
reg_densites_an <- reg_sp %>% 
  group_by(dept, annee, esp_code_alternatif) %>% 
    summarise(densite_qd_pres_med = median(densite, na.rm = TRUE),
              densite_qd_pres_moy = mean(densite, na.rm = TRUE),
              densite_yc_abs_moy = 1000 * sum(effectif, na.rm = TRUE) / sum(ope_surface_calculee,
                                                                            na.rm = TRUE)) %>% 
  ungroup()


# noms d'espèces en clair
reg_densites_an <- reg_densites_an %>% 
  left_join(y = ref_espece %>% 
              select(esp_code_alternatif,
                     esp_nom_commun))
```

## Espèces

On a des graphiques séparés pour les écrevisses, les poissons EEE et les autres espèces. Les espèces sont ordonnées par densités moyennes décroissantes. Les échelles des axes des densités sont différents selon les espèces pour éviter que les plus abondantes n'écrasent les autres qui deviendraient illisibles.

On a en ordonnée la densité moyenne du taxon chaque dans le département.



```{r}
# Liste des noms d'espèces par groupe
ecr <- ref_espece %>% 
  filter(str_detect(esp_nom_commun, "Ecrevisse") | esp_code_alternatif == "APT") %>% 
  filter(esp_code_alternatif != "ECR") %>% 
  pull(esp_nom_commun)

eee <- ref_espece %>% 
  filter(esp_code_alternatif %in% c("PES", "PCH", "PSR", "OPG")) %>% 
  pull(esp_nom_commun)

poissons_loc <- reg_densites_an %>% 
  pull(esp_nom_commun) %>% 
  unique() %>% 
  setdiff(eee) %>% 
  setdiff(ecr)
```


### Poissons


```{r}
reg_densites_an_poissons_loc <- reg_densites_an %>%
  filter(esp_nom_commun %in% poissons_loc)
```





## Les espèces par département

Ici la taille des points indique le pourcentage des stations échantillonnées dans le département où l'espèce était présente (pour la dernière année de données). Les écrevisses sont indiquées en bleu. Les espèces sont ordonnées par nombre de départements de présence, puis par nombre total d'occurrences.

Exemple : Si, dans le 56, le chevaine a été capturé sur 8 des 16 stations prospectées en 2022. Son taux d'occurrence dans ce département est donc de 50%. 

```{r, fig.height = 9, fig.width = 7, dpi = 300}
reg_effectif_mon_annee <- reg_data %>% 
  mef_ajouter_dept() %>% 
  mef_ajouter_lots() %>% 
  filter(annee == params$mon_annee) %>% 
  mutate(esp_code_alternatif = ifelse(esp_code_alternatif == "CMI",
                                      "CCO",
                                      esp_code_alternatif)) %>% 
  group_by(pop_id, dept, esp_code_alternatif) %>% 
    summarise(effectif = sum(lop_effectif),
              .groups = "drop") %>% 
  left_join(y = ref_espece %>% 
              select(esp_code_alternatif, esp_nom_commun)) %>% 
  mutate(esp_nom_commun = paste0(esp_nom_commun,
                                 " (",
                                 esp_code_alternatif,
                                 ")"))

# mic mac pour ordonner les départements de manière aussi "emboîtée" que possible
nb_pop_par_dept_mon_annee <- reg_effectif_mon_annee %>% 
  group_by(dept) %>% 
    summarise(n_pop = n_distinct(pop_id))

n_occ_par_esp_par_dept_mon_annee <- reg_effectif_mon_annee %>% 
  group_by(dept, esp_nom_commun) %>% 
    tally()

pc_occ_par_dept_mon_annee <- n_occ_par_esp_par_dept_mon_annee %>% 
  left_join(y = nb_pop_par_dept_mon_annee) %>% 
  mutate(pc_occ = n / n_pop,
         dept_fct = as.factor(dept),
         dept_fct = fct_relevel(dept_fct, "35", "56", "29", "22"))

ordre_esp <- reg_effectif_mon_annee %>% 
  group_by(esp_nom_commun) %>% 
  summarise(n_dept = n_distinct(dept),
            n_occ = sum(effectif > 0)) %>% 
  ungroup() %>% 
  arrange(n_dept, n_occ)

pc_occ_par_dept_mon_annee <- pc_occ_par_dept_mon_annee %>% 
  left_join(ordre_esp) %>%
  mutate(esp_nom_commun = factor(esp_nom_commun,
                                 ordre_esp$esp_nom_commun),
         couleur = ifelse(str_detect(esp_nom_commun, "Ecrev"),
                          "blue",
                          "black"))

# identification des écrevisses par une couleur bleue sur l'axe des espèces
couleurs_ecr <- pc_occ_par_dept_mon_annee %>%
  group_by(esp_nom_commun) %>%
  slice(1) %>%
  pull(couleur)
```

## Abondance numérique



## Abondance massique

```{r}
reg_mei <- reg_data %>%
  mef_ajouter_mei() %>%
  mef_ajouter_lots() %>%
  mef_ajouter_type_longueur() %>%
  mef_ajouter_esp() %>%
  select(
    mei_id,
    sta_id,
    pop_id,
    dept,
    annee,
    ope_date,
    lop_id,
    esp_code_alternatif,
    esp_nom_commun,
    mei_taille,
    mei_poids,
    mei_poids_estime,
    mei_mesure_reelle,
    tlo_libelle
  )

# utilisation des relations taille - poids du package aspe
data("taille_poids")

taille_poids <- taille_poids %>%
  group_by(esp_code_alternatif,
           tlo_libelle) %>%
  arrange(source) %>%
  slice(1)


# nb vérifier qu'on a bien les tailles pour tous les poissons avant d'appliquer la taille-poids
# combinaisons espèces - type de longueur absentes de la table de conversion
tp_manquantes <- reg_mei %>% 
  select(esp_code_alternatif, tlo_libelle) %>% 
  distinct() %>% 
  left_join(y = taille_poids) %>% 
  filter(is.na(a))
# on voit que le pb est que pas mal d'espèces n'ont pas de relation en longueur fourche
# on approxime par la longueur totale
esp_tp_manquantes <- tp_manquantes %>% 
  pull(esp_code_alternatif)

reg_poids <- reg_mei %>%
  mutate(tlo_libelle = ifelse(esp_code_alternatif %in% esp_tp_manquantes &
                                tlo_libelle == "Fourche",
         "Totale",
         tlo_libelle))

reg_poids <- reg_poids %>% 
  left_join(y = taille_poids,
            by = c("esp_code_alternatif", "tlo_libelle")) %>%
  mutate(mei_taille = mei_taille / 10,   # passage en cm
         poids_tp = a * (mei_taille ^ b),
         erreur_abs = poids_tp - mei_poids,
         erreur_rel = erreur_abs / poids_tp)

# test <- poids %>%
#   filter(is.na(poids_tp)) %>%
#   group_by(esp_code_alternatif, esp_nom_latin, tlo_libelle) %>%
#   tally()

reg_poids <- reg_poids %>% 
  group_by(esp_nom_commun,
           annee,
           dept) %>% 
  summarise(poids = sum(poids_tp, na.rm = TRUE),
            .groups = "drop")
```

```{r}
# ggplot(data = poids_dept,
#        aes(x = fct_reorder(esp_nom_commun, poids),
#            y = poids)) +
#   geom_bar(stat = "identity",
#            fill = "darkgreen") +
#   coord_flip() +
#   scale_y_continuous(labels = scales::label_number(big.mark = "",
#                                                   accuracy = 1,
#                                                   scale = 1e-3)) +
#   labs(x = "",
#        y = "Biomasse capturée (kg)")
```


## Richesse spécifique

```{r}
data("traits_bio")

reg_rs <- reg_data %>% 
  mef_ajouter_lots %>% 
#  mef_ajouter_dept() %>% 
  select(esp_code_alternatif,
         annee,
         dept) %>% 
  distinct() %>% 
  left_join(y = traits_bio %>% 
              select(esp_code_alternatif,
                     introduite = Introduite)) %>%
  filter(!is.na(introduite)) %>% 
  group_by(dept, annee, introduite) %>% 
  summarise(rs = n_distinct(esp_code_alternatif)) %>% 
  ungroup() %>% 
  mutate(espece = ifelse(test = introduite == TRUE, "Introduites", "Autochtones"))
  
# 
# ggplot(data = rs,
#        aes(x = annee,
#            y = rs, col= espece)) +
#   geom_line() + 
#   scale_y_continuous(limits = c(0, NA)) +
#   labs(y = "Richesse spécifique", x = "", col = "Espèces") + 
#   scale_color_brewer(palette = "Set1")
```




## Distribution en taille pour les principales espèces

En inter-annuel, pour les 10 espèces avec les effectifs les plus abondants.

```{r}
# on part des mesures individuelles
reg_longueurs <- reg_mei %>% 
  filter(mei_taille > 0) %>% 
  mef_ajouter_lots() %>% 
  mef_ajouter_esp()

# Histo cumulé pluri-annuel : Les espèces avec mini 1000 individus sur la période
# mes_especes <- longueurs %>% 
#   group_by(esp_code_alternatif) %>% 
#   tally() %>% 
#   arrange(-n) %>%
#   slice(1:10) %>%
#   pull(esp_code_alternatif)
# 
# longueurs <- longueurs %>% 
#   filter(esp_code_alternatif %in% mes_especes)

```

```{r, fig.height = 8, results = 'hide'}
# map(.x = mes_especes,
#     .f = gg_dyn_esp,
#     df = longueurs,
#     var_id_espece = esp_code_alternatif,
#     var_id_station = pop_id,
#     seuil = 0.01,
#     graph_long_mediane = FALSE,
#     graph_mois = FALSE,
#     graph_effectif = F
# )
```

## Variables environnementales

```{r}
# données environnementales simples à l'opération
reg_donnees_env <- operation_description_peche %>% 
  filter(odp_ope_id %in% mes_ope_reg) %>% 
  select(ope_id = odp_ope_id,
         odp_conductivite,
         odp_tension,
         odp_intensite,
         odp_temperature_instantanee,
         odp_largeur_lame_eau,
         odp_longueur
         ) %>% 
  left_join(y = operation_donnees_environnementales %>% 
              select(ope_id = ode_ope_id,
                     profondeur_moyenne = ode_profondeur_moyenne_station))

# granulométrie dominante par opération
reg_granu <- facies %>% 
  select(ope_id = fac_ode_ope_id,
         fac_tyf_id,
         fac_importance_relative,
         fac_gra_id_dominante) %>% 
  filter(ope_id %in% mes_ope_reg) %>% 
  group_by(ope_id) %>% 
  summarise(granu_dom = weighted.mean(x = fac_gra_id_dominante,
                                      w = fac_importance_relative,
                                      na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(granu_dom = round(granu_dom))


# assemblage des deux tables
reg_donnees_env <- reg_donnees_env %>% 
  left_join(y = reg_granu) %>%  
  pivot_longer(cols = odp_conductivite:granu_dom,
               names_to = "variable",
               values_to = "valeur") %>% 
  mef_ajouter_ope_date() %>% 
  left_join(reg_ope %>% 
              select(ope_id, dept)) %>% 
  select(-ope_date) %>% 
  group_by(annee, variable, dept) %>% 
    summarise(mediane = median(valeur, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(variable = str_replace(string = variable,
                                pattern = "odp_",
                                replacement = ""))
```

```{r}
# ggplot(data = mes_donnees_env,
#        aes(x = annee,
#            y = mediane)) +
#   geom_line() +
#   facet_wrap(~variable,
#              scales = "free_y")
```
```{r, fig.width = 8}
# ggplotExtra::gg_lattice_line(
#   df = mes_donnees_env,
#   var_x = annee,
#   var_y = mediane,
#   var_lattice = variable,
#   threshold_x = 2007,
#   lab_y = "Valeur médiane de la variable",
#   free_y = TRUE
# )
```

## Métriques IPR

```{r}
reg_metrique <- operation_ipr %>% 
  filter(opi_ope_id %in% mes_ope_reg) %>%
  rename(ope_id = opi_ope_id) %>% 
  mef_ajouter_ope_date()
```

```{r}
# ggplot(data = metrique,
#        aes(x = annee,
#            y = mediane,
#            color = (annee < 2007))) +
#   geom_path(group = 1) +
#   facet_wrap(~metrique,
#              scales = "free_y") +
#   guides(color = "none") +
#   labs(x = "",
#        y = "Valeur médiane de la métrique")
```

```{r}
# ggplotExtra::gg_lattice_line(
#   df = metrique,
#   var_x = annee,
#   var_y = mediane,
#   var_lattice = metrique,
#   threshold_x = 2007,
#   lab_y = "Valeur médiane de la métrique"
# )
```
```{r, fig.width = 8}
# ggplotExtra::gg_lattice_ipr(
#   df = metrique,
#   var_y = mediane,
#   var_lattice = metrique,
#   metriques = TRUE,
#   interactif = TRUE
# )
```


# A l'échelle de la station

## Probabilité de présence des espèces

```{r}
# pp <- probabilite_presence_ipr %>%
#   filter(ppi_opi_ope_id %in% mes_ope_reg) %>%
#   rename(ope_id = ppi_opi_ope_id,
#          esp_id = ppi_esp_id) %>%
#   left_join(y = ref_espece %>%
#               select(esp_id,
#                      esp_code_alternatif,
#                      esp_nom_commun))
# 
# pa <- dept_sp %>%
#   select(ope_id,
#          esp_code_alternatif,
#          effectif) %>%
#   mutate(
#     esp_code_alternatif = case_when(
#       esp_code_alternatif %in% c("CAA", "CAG", "CAD", "CAS") ~ "CAX",
#       esp_code_alternatif == "GOU" ~ "GOX",
#       esp_code_alternatif == "VAI" ~ "PHX",
#       esp_code_alternatif %in% c("VAX", "VAR") ~ "VAN",
#       TRUE ~ esp_code_alternatif
#     ),
#     presence = ifelse(
#       test = (effectif > 0),
#       yes = "Présence",
#       no = "Absence"
#     )
#   )
# 
# pp <- pp %>%
#   left_join(pa) %>%
#   mutate(presence = ifelse(is.na(presence),
#                      "Absence",
#                      presence)) %>% 
#   left_join(operation %>% 
#               select(ope_id, 
#                      pop_id = ope_pop_id))
# 
# libelles <- dept_sp %>%
#   select(ope_id,
#          sta_id,
#          pop_id) %>% 
#   distinct() %>% 
#   mef_ajouter_libelle() %>% 
#   select(ope_id, pop_libelle)
# 
# pp <- pp %>% 
#   left_join(libelles)
```

```{r}
# mon_operation <- 6855
# 
# mon_point <- pp %>% 
#   filter(ope_id == mon_operation) %>% 
#   pull(pop_id) %>% 
#   unique()
#   
# 
# test <- pp %>% 
#   filter(ope_id == mon_operation) %>% 
#   mutate(esp_nom_commun = fct_reorder(esp_nom_commun, ppi_valeur_probabilite),
#          couleur = ifelse(presence == "Présence",
#                           "#1B9E77",
#                           "#D95F02")) %>% 
#   arrange(esp_nom_commun)
# 
# ma_station <- test %>% 
#   pull(pop_libelle) %>% 
#   unique()
```

```{r}
# ggplot(data = test,
#        aes(x = esp_nom_commun,
#            y = ppi_valeur_probabilite,
#            fill = presence)) +
#   geom_bar(stat = "identity") +
#   coord_flip() +
#   labs(x = "",
#        y = "Probabilité de présence",
#        title = ma_station,
#        fill = "") +
#   scale_y_continuous(labels = scales::percent) +
#   theme(legend.position = "bottom",
#         axis.text = element_text(size = 8),
#         axis.text.y = element_text(colour = test$couleur),
#         legend.text = element_text(size = 8),
#         legend.title = element_text(size = 9)) +
#   scale_fill_brewer(palette = "Dark2", direction = -1)
```

## densité numérique 

```{r}
# densites_sta <- dept_sp %>% 
#     filter(pop_id == mon_point)
# 
# esp_sel <- densites_sta %>% 
#   group_by(esp_code_alternatif) %>% 
#   summarise(dens = sum(densite, 
#                        na.rm = TRUE)) %>% 
#   filter(dens > 0) %>% 
#   pull(esp_code_alternatif)
# 
# densites_sta <- densites_sta %>% 
#   filter(esp_code_alternatif %in% esp_sel) %>% 
#   mutate(annee = as.integer(annee))
# 
# ggplot(data = densites_sta,
#        aes(x = annee,
#                          y = densite)) + 
#   geom_line() + 
#   facet_wrap(~ esp_code_alternatif, 
#              scales = "free_y") +
#  scale_x_continuous(labels = scales::label_number(big.mark = "",
#                                                   accuracy = 1))

```

## densité pondérale

```{r}

```

# sauvegarde

```{r}
save(ma_reg,
     mes_ope_reg,
     ecr,
     eee,
     poissons_loc,
     pc_occ_par_dept_mon_annee,
     couleurs_ecr,
     classe_ipr,
     reg_data,
     reg_ope,
     reg_densites_an,
     reg_densites_an_poissons_loc,
     reg_poids,
     reg_effectif_mon_annee,
     reg_mei,
     reg_longueurs,
     reg_donnees_env,
     reg_metrique,
     reg_ipr,
     reg_ipr_mediane,
     reg_rs,
     file = "../processed_data/reg_data.RData")
```

